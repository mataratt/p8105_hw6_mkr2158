---
title: "Homework 6"
author: Matariya Rattanapan
output: github_document
date: "2025-12-03"
---

```{r setup, include=FALSE}
library(tidyverse)
library(p8105.datasets)
library(modelr)
library(viridis)
library(broom)

data("weather_df")

set.seed(1)
```

## Problem 1

N/A

## Problem 2

#### Cleaning up `weather_df` data, fitting linear model, and bootstrapping
```{r}
weather_df =
  weather_df |> 
  drop_na(tmax, tmin, prcp)

#Fitting linear model

fit = lm(tmax ~ tmin + prcp, data = weather_df)

#Bootstrapping
weather_bootstrap =
  weather_df |> 
  modelr::bootstrap(n = 5000) |> 
  mutate(
    models = map(strap, \(df) lm(tmax ~ tmin + prcp, data = df)),
    glance = map(models, broom::glance),
    tidy   = map(models, broom::tidy)
  )

#Getting bootstrapped r2
r2 =
  weather_bootstrap |> 
  unnest(glance) |> 
  select(.id, r.squared)

#Getting beta1 and beta2

betas =
  weather_bootstrap |> 
  unnest(tidy) |> 
  filter(term %in% c("tmin", "prcp")) |> 
  select(.id, term, estimate) |> 
  pivot_wider(
    names_from = term,
    values_from = estimate
  ) |> 
  rename(
    beta1 = tmin,
    beta2 = prcp
  ) |> 
  mutate(
    beta_ratio = beta1/beta2
  )

#Combining estimates into one df
weather_estimates =
  left_join(r2, betas, by=".id")
```

#### Plotting the distribution of estimates
```{r}
#R2 Distribution
weather_estimates |> 
  ggplot(aes(x = r.squared)) +
  geom_density(linewidth = 0.8, fill = "#440154", alpha = 0.5) +
  labs(
    title = expression(bold("Figure 1. Distribution for R"^2)),
    x = expression(bold("R"^2)),
    y = expression(bold("Density"))
  )
  
#Beta Distribution
weather_estimates |> 
  ggplot(aes(x = beta_ratio)) +
  geom_density(linewidth = 0.8, fill = "#3b528b", alpha = 0.5) +
  labs(
    title = expression(bold("Figure 2. Distribution for " *beta[1]* "/ " *beta[2])),
    x = expression(bold("Estimate")),
    y = expression(bold("Density"))
  )  
```

* The distribution for R<sup>2</sup> is relatively normally skewed and symmetric. The data is highly concentrated near 0.94 with little fluctuation in the sample. 
* The distribution for β<sub>1</sub> /β<sub>2</sub>, (`tmin`/`prcp`) is noticeably right-skewed (much of the data is concentrated -250 and onward). Large negative outliers may be attributed to precipitation `prcp` being small and near zero, thereby leading to a longer left tail. 

#### Calculating 2.5% and 97.5% quantiles and providing a 95% confidence interval
```{r}
weather_estimates |> 
  summarize(
    r2_lower  = quantile(r.squared, 0.025),
    r2_upper  = quantile(r.squared, 0.975),
    betar_lower  = quantile(beta_ratio, 0.025),
    betar_upper  = quantile(beta_ratio, 0.975)
  ) |> 
  knitr::kable()
```

* The 95% confidence interval for R<sup>2</sup> is (0.93, 0.95), which is very narrow. This supports the model's ability to strongly explain variation in temperature.
* The 95% confidence interval for β<sub>1</sub> /β<sub>2</sub> is (-274.79, -125.48), a much wider interval. There is more variability likely due to precipation `prcp` being a smaller and in the denominator.

## Problem 3

#### Importing data and cleaning up data
```{r, message = FALSE}
birthweight =
  read_csv("data/birthweight.csv", na = c("NA", ".", "")) |> 
  mutate(
    babysex = factor(babysex),
    frace = factor(frace),
    malform = factor(malform),
    mrace = factor(mrace),
  )

#Checking for any missing data
birthweight |> 
  summarize(across(everything(), \(x) sum(is.na(x))))
  
```
* There is no presence of missing data, so we will move forward with building our model.

#### Building Main Regression Model for Birthweight
```{r}
birthweight_model =
  lm(bwt ~ babysex + frace + gaweeks + malform + momage + mrace + ppbmi + smoken, data = birthweight)

tidy(birthweight_model) |> 
  knitr::kable()
```

* My modeling process derives from previous research and literature on factors influencing birth weight.
  * `babysex`: selected since male infants generally may have higher average birth weights compared to female infants
  * `frace`: selected since a father's genetic code may influence the growth which can influence birth weight
  * `gaweek`: selected since there is a general positive association between gestational week and birth week
  * `malform`: selected as birth defects may lead to lower birth weights
  * `momage`: selected as extreme ages (very young vs. very old) may lead to variations in risk of extreme low/high birth weights
  * `mrace`: selected since a mother's genetic code may influence growth which influence birth weight
  * `ppbmi`: selected because pre-pregnancy BMI is directly correlated with birth weight. Low pre-pregnancy BMI may lead to lower birth weight and vice versa
  * `smoken`: selected because smoking causes a dose-response effect where higher number of cigarettes may lead to lower birth weight
  
#### Plotting Residuals vs. Fitted Values

```{r}
birthweight |> 
  modelr::add_predictions(birthweight_model) |> 
  modelr::add_residuals(birthweight_model) |> 
  ggplot(aes(x = pred, y = resid)) +
  geom_point(alpha = 0.25) +
  geom_hline(yintercept = 0, color = "red", linetype = "dashed") +
  labs(
    title = expression(bold("Figure 3. Residuals vs. Fitted values for Birth Weight Model")),
    x = "Fitted Birth Weight (grams)",
    y = "Residuals"
  )
```














